name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Inject KV ID
        # ä»…ä¿ç•™è¿™ä¸€æ­¥ä¿®æ”¹ wrangler.toml é‡Œçš„ KV ç»‘å®š
        run: |
          sed -i 's/id\s*=\s*""/id = "${{ secrets.CF_KV_ID }}"/' wrangler.toml

      - name: ðŸš€ Deploy as Plain Text Vars
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          # æ ¸å¿ƒæ”¹è¿›ï¼šç›´æŽ¥åœ¨è¿™é‡Œå®šä¹‰ï¼ŒWrangler ä¼šæŠŠå®ƒä»¬å½“ä½œæ˜Žæ–‡å˜é‡(Vars)ä¸Šä¼ 
          # è¿™æ ·ä½ åœ¨ CF åŽå°çœ‹åˆ°çš„å°±æ˜¯æ–‡æœ¬çŠ¶æ€
          vars: |
            AUTH_PASSWORD
          command: deploy
        env:
          # å°† GitHub Secret æ˜ å°„ç»™ä¸Šé¢çš„ vars é…ç½®ä½¿ç”¨
          AUTH_PASSWORD: ${{ secrets.AUTH_PASSWORD }}

      - name: ðŸ” Debug Status
        if: always()
        run: |
          echo "### éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- **å˜é‡æ¨¡å¼**: æ˜Žæ–‡æ–‡æœ¬ (Plain Text Vars)" >> $GITHUB_STEP_SUMMARY
          echo "- **æ£€æŸ¥ä½ç½®**: Cloudflare Dashboard -> Settings -> Variables" >> $GITHUB_STEP_SUMMARY
